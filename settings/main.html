<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hello Chama â€“ Dashboard</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
  body { font-family: "Roboto", sans-serif; background-color: #f8f9fa; margin:0; overflow-x:hidden; }
  .navbar { background-color: #1e2a38; color:white; height:60px; position:fixed; top:0; left:0; right:0; z-index:1100; }
  .navbar .navbar-brand { color:#00b894; font-weight:600; }
  .sidebar-toggle { font-size:1.5rem; color:white; cursor:pointer; display:none; }
  .layout { display:flex; margin-top:60px; min-height:calc(100vh - 60px); transition:all 0.3s; }
  .sidebar { width:250px; background:white; border-right:1px solid #ddd; padding-top:1rem; position:sticky; top:60px; height:calc(100vh - 60px); overflow-y:auto; transition: transform 0.3s ease; }
  .sidebar.collapsed { transform: translateX(-100%); }
  .sidebar a { display:block; color:#333; padding:0.6rem 1rem; text-decoration:none; font-weight:500; border-radius:6px; margin:0.2rem 0; transition: all 0.2s; }
  .sidebar a:hover { background:#e8f8f5; color:#00b894; }
  .sidebar a.active { background:#00b894; color:white; }
  .content { flex:1; padding:2rem; background-color:#f8f9fa; overflow-y:auto; }
  .profile-pic { width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid #00b894; }
  .notification-badge { position:absolute; top:0; right:0; background:red; color:white; font-size:0.6rem; border-radius:50%; width:15px; height:15px; display:flex; align-items:center; justify-content:center; }
  .progress { height:10px; border-radius:5px; margin-bottom:1rem; }
  .progress-bar { transition: width 0.5s; }
  @media(max-width:992px){ .layout{flex-direction:column;} .sidebar{position:fixed;top:60px;left:0;height:calc(100vh - 60px);z-index:1200;} .sidebar-toggle{display:block;} .content{padding:1rem;} }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg px-3 d-flex align-items-center">
  <span class="sidebar-toggle me-3"><i class="bi bi-list"></i></span>
  <a class="navbar-brand" href="#">Hello Chama</a>
  <div class="ms-auto d-flex align-items-center gap-3">
    <div class="position-relative"><i class="bi bi-bell fs-5 text-white"></i><span class="notification-badge">3</span></div>
    <div class="position-relative"><i class="bi bi-envelope fs-5 text-white"></i><span class="notification-badge">2</span></div>
    <div class="dropdown">
      <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="../img/profile1.jpg" alt="Profile" class="profile-pic me-2">
        <span id="welcomeName"></span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow">
        <li><a class="dropdown-item" href="#" id="profileBtn"><i class="bi bi-person me-2"></i>Profile</a></li>
        <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Layout -->
<div class="layout">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebarMenu">
    <a href="#" class="active" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
    <a href="#" data-page="group"><i class="bi bi-people-fill me-2"></i>Group Setup</a>
    <a href="#" data-page="modules"><i class="bi bi-layers-fill me-2"></i>Modules Setup</a>
    <a href="#" data-page="billing"><i class="bi bi-credit-card-2-front-fill me-2"></i>Billing</a>
    <a href="#" data-page="terms"><i class="bi bi-file-earmark-text-fill me-2"></i>Terms</a>
  </div>

  <!-- Content -->
  <main class="content" id="mainContent">
    <h3 class="fw-bold text-success mb-3"><i class="bi bi-speedometer2 me-2"></i>Welcome, <span id="userNameDisplay">User</span>!</h3>

    <div class="progress">
      <div id="stepProgressBar" class="progress-bar bg-info" role="progressbar" style="width:0%;"></div>
    </div>

    <div class="alert alert-info" id="getStartedContainer">
      <p>Minimum steps to get started:</p>
      <ul>
        <li>Create and update your <strong>profile</strong>.</li>
        <li>Set up your first <strong>group</strong> in the system.</li>
        <li>Optionally, configure basic <strong>modules</strong>.</li>
      </ul>
      <button id="getStartedBtn" class="btn btn-success mt-2"><i class="bi bi-play-fill me-2"></i>Get Started</button>
    </div>

    <div id="contentContainer" class="mt-4"></div>
  </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ----- Sidebar & User -----
  const sidebar = document.getElementById("sidebarMenu");
  const toggleBtn = document.querySelector(".sidebar-toggle");
  const userNameDisplay = document.getElementById("userNameDisplay");
  const welcomeName = document.getElementById("welcomeName");

  if(window.innerWidth<=992) sidebar.classList.add("collapsed");
  toggleBtn.addEventListener('click', ()=>sidebar.classList.toggle('collapsed'));
  window.addEventListener('resize', ()=>{ if(window.innerWidth<=992) sidebar.classList.add("collapsed"); else sidebar.classList.remove("collapsed"); });

  const username = sessionStorage.getItem("username")||"User";
  welcomeName.textContent = `Hi, ${username}`;
  userNameDisplay.textContent = sessionStorage.getItem("fullName")||"User";

  const navLinks = sidebar.querySelectorAll('a[data-page]');
  navLinks.forEach(link=>{
    link.addEventListener('click', e=>{
      e.preventDefault();
      navLinks.forEach(l=>l.classList.remove('active'));
      link.classList.add('active');
      loadPage(link.dataset.page);
      if(window.innerWidth<=992) sidebar.classList.add("collapsed");
    });
  });

  document.getElementById("profileBtn").addEventListener('click', e=>{ e.preventDefault(); loadPage("profile_management"); if(window.innerWidth<=992) sidebar.classList.add("collapsed"); });
  document.getElementById("logoutBtn").addEventListener('click', e=>{ e.preventDefault(); sessionStorage.clear(); localStorage.clear(); window.location.href="../index.html"; });

  function loadPage(page){ fetch(`${page}.html`).then(r=>r.text()).then(html=>document.getElementById("mainContent").innerHTML=html).catch(()=>document.getElementById("mainContent").innerHTML=`<p class="text-danger">Failed to load ${page}.html</p>`); }

  // ----- Onboarding Flow -----
  const getStartedBtn = document.getElementById("getStartedBtn");
  const getStartedContainer = document.getElementById("getStartedContainer");
  const contentContainer = document.getElementById("contentContainer");
  const stepProgressBar = document.getElementById("stepProgressBar");

  const onboardingData = { group:{}, activities:[], subModules:{}, billing:"Trial", termsAccepted:false };
  const activitySubModules = {
    "Welfare":["Basic Contributions","Emergency Fund","Member Welfare"],
    "Merry-Go-Round":["Contribution Schedule","Winner Rotation"],
    "Table Banking":["Table Setup","Loan Terms","Repayment Schedule"],
    "Investment":["Investment Plan","ROI Tracking"]
  };

  const pages = {
    group: ()=>`
      <h4 class="fw-bold text-success mb-3">Step 1: Set Up Your First Group</h4>
      <form id="groupForm" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Group / Chama Name</label>
          <input type="text" class="form-control" id="groupName" value="${onboardingData.group.name||''}" placeholder="Enter group name" required>
        </div>
        <div class="col-12">
          <label class="form-label">Purpose / Description</label>
          <textarea class="form-control" id="groupDescription" rows="2" placeholder="Briefly describe the group">${onboardingData.group.description||''}</textarea>
        </div>
        <div class="col-12 d-flex justify-content-between">
          <button type="submit" class="btn btn-success">Save & Continue</button>
        </div>
      </form>
    `,
    group_activities: ()=>`
      <h4 class="fw-bold text-success mb-3">Step 2: Select Group Activities</h4>
      <form id="activitiesForm">
        ${["Welfare","Merry-Go-Round","Table Banking","Investment"].map(a=>`
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${a}" id="act${a.replace(/\s/g,'')}" ${onboardingData.activities.includes(a)?'checked':''}>
            <label class="form-check-label" for="act${a.replace(/\s/g,'')}">${a}</label>
          </div>
        `).join('')}
        <div class="mt-3" id="activitiesSubModulesContainer"></div>
        <div class="mt-3 d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" onclick="loadOnboardingPage('group',1)">Back</button>
          <button type="submit" class="btn btn-success">Save & Continue</button>
        </div>
      </form>
    `,
    bill: ()=>`
      <h4 class="fw-bold text-success mb-3">Step 3: Billing Setup</h4>
      <form id="billingForm">
        <div class="form-check"><input class="form-check-input" type="radio" name="billing" value="Trial" id="trial" ${onboardingData.billing==='Trial'?'checked':''}><label class="form-check-label" for="trial">Trial (Default)</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="billing" value="Paid" id="paid" ${onboardingData.billing==='Paid'?'checked':''}><label class="form-check-label" for="paid">Paid</label></div>
        <div class="mt-3 d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" onclick="loadOnboardingPage('group_activities',2)">Back</button>
          <button type="submit" class="btn btn-success">Save & Continue</button>
        </div>
      </form>
    `,
    terms: ()=>`
      <h4 class="fw-bold text-success mb-3">Step 4: Accept Terms & Conditions</h4>
      <form id="termsForm">
        <div class="form-check"><input class="form-check-input" type="checkbox" id="acceptTerms" ${onboardingData.termsAccepted?'checked':''} required>
        <label class="form-check-label" for="acceptTerms">I accept the terms and conditions</label></div>
        <div class="mt-3 d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" onclick="loadOnboardingPage('bill',3)">Back</button>
          <button type="submit" class="btn btn-success">Finish Onboarding</button>
        </div>
      </form>
    `,
    welcome_group: ()=>`
      <h4 class="fw-bold text-success mb-3">Welcome to Your Group!</h4>
      <p>You have successfully completed onboarding. Here's a summary of your choices:</p>
      <div class="card">
        <div class="card-body">
          <h5>Group: ${onboardingData.group.name}</h5>
          <p>Purpose: ${onboardingData.group.description}</p>
          <h6>Activities Selected:</h6>
          <ul>${onboardingData.activities.map(a=>`<li>${a} (${onboardingData.subModules[a]?.join(', ')||'default'})</li>`).join('')}</ul>
          <p>Billing: ${onboardingData.billing}</p>
        </div>
      </div>
    `
  };

  function loadOnboardingPage(page, step=0){
    getStartedContainer.style.display = 'none';
    contentContainer.innerHTML = pages[page]();
    stepProgressBar.style.width = `${step*20}%`;
    stepProgressBar.className = 'progress-bar ' + (step<4?'bg-info':(step<5?'bg-warning':'bg-success'));

    // Group Form
    if(page==='group'){
      document.getElementById('groupForm').addEventListener('submit', e=>{
        e.preventDefault();
        onboardingData.group = {
          name: document.getElementById('groupName').value,
          description: document.getElementById('groupDescription').value
        };
        loadOnboardingPage('group_activities',2);
      });
    }

    // Activities Form
    if(page==='group_activities'){
      const form = document.getElementById('activitiesForm');
      const subModulesContainer = document.getElementById('activitiesSubModulesContainer');

      form.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          onboardingData.activities = [...form.querySelectorAll('input[type="checkbox"]:checked')].map(c=>c.value);
          renderActivitiesSubModules(subModulesContainer);
        });
      });
      renderActivitiesSubModules(subModulesContainer);

      form.addEventListener('submit', e=>{
        e.preventDefault();
        if(!onboardingData.activities.length){ alert('Select at least one activity'); return; }
        loadOnboardingPage('bill',3);
      });
    }

    // Billing Form
    if(page==='bill'){
      document.getElementById('billingForm').addEventListener('submit', e=>{
        e.preventDefault();
        const billing = document.querySelector('input[name="billing"]:checked').value;
        onboardingData.billing = billing;
        if(billing==='Paid') alert('Redirect to payment page (placeholder)');
        loadOnboardingPage('terms',4);
      });
    }

    // Terms Form
    if(page==='terms'){
      document.getElementById('termsForm').addEventListener('submit', e=>{
        e.preventDefault();
        if(!document.getElementById('acceptTerms').checked){ alert('Accept terms to continue'); return; }
        onboardingData.termsAccepted = true;
        loadOnboardingPage('welcome_group',5);
      });
    }
  }

  // Render sub-modules dynamically
  function renderActivitiesSubModules(container){
    container.innerHTML = '';
    onboardingData.activities.forEach((act)=>{
      const collapseId = `collapse-${act.replace(/\s/g,'')}`;
      const card = document.createElement('div');
      card.className = 'card mb-2';
      card.innerHTML = `
        <div class="card-header fw-bold d-flex justify-content-between align-items-center" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="true">
          ${act} Sub-Modules
          <i class="bi bi-chevron-down" id="icon-${collapseId}"></i>
        </div>
        <div id="${collapseId}" class="collapse show">
          <div class="card-body" id="subModules-${act}">
            ${activitySubModules[act].map(sub=>{
              const selected = onboardingData.subModules[act]?.includes(sub) ? 'checked' : '';
              return `<div class="form-check"><input class="form-check-input" type="checkbox" value="${sub}" id="${act}-${sub}" ${selected}>
                      <label class="form-check-label" for="${act}-${sub}">${sub}</label></div>`;
            }).join('')}
          </div>
        </div>
      `;
      container.appendChild(card);

      const bsCollapse = new bootstrap.Collapse(document.getElementById(collapseId), { toggle:false });
      const header = card.querySelector('.card-header');
      const icon = document.getElementById(`icon-${collapseId}`);
      header.addEventListener('click', ()=>{
        bsCollapse.toggle();
        icon.classList.toggle('bi-chevron-down');
        icon.classList.toggle('bi-chevron-up');
      });

      card.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          onboardingData.subModules[act] = [...card.querySelectorAll('input[type="checkbox"]:checked')].map(c=>c.value);
        });
      });
    });
  }

  getStartedBtn.addEventListener('click', ()=>loadOnboardingPage('group',1));
</script>
</body>
</html>
